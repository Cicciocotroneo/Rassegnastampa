<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fattariellows of the day</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1, h2, h3 {
            color: #333;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
        }
        .form-container {
            margin-bottom: 20px;
        }
        input[type="url"], input[type="text"] {
            width: 70%;
            padding: 10px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }
        button:hover {
            background-color: #45a049;
        }
        #extraction-results {
            display: none;
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .field-container {
            margin-bottom: 20px;
        }
        .field-label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        textarea {
            min-height: 300px;
            resize: vertical;
        }
        .error {
            color: red;
            font-weight: bold;
            padding: 10px;
            background-color: #ffe6e6;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: green;
            font-weight: bold;
            padding: 10px;
            background-color: #e6ffe6;
            border-radius: 4px;
            margin: 10px 0;
        }
        .loading {
            text-align: center;
            font-style: italic;
            color: #666;
            padding: 10px;
        }
        .info-text {
            color: #666;
            font-style: italic;
            margin-top: 5px;
        }
        .action-buttons {
            display: flex;
            margin-top: 20px;
            gap: 10px;
            flex-wrap: wrap;
        }
        #save-article-btn {
            background-color: #2196F3;
        }
        #save-article-btn:hover {
            background-color: #0b7dda;
        }
        #generate-press-review-btn {
            background-color: #673AB7;
        }
        #generate-press-review-btn:hover {
            background-color: #5E35B1;
        }
        #export-data-btn {
            background-color: #FF9800;
        }
        #export-data-btn:hover {
            background-color: #F57C00;
        }
        #reset-data-btn {
            background-color: #f44336;
        }
        #reset-data-btn:hover {
            background-color: #d32f2f;
        }
        
        /* Stili per la tabella degli articoli salvati */
        #saved-articles-container {
            margin-top: 30px;
            display: none;
        }
        .saved-articles-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .saved-articles-table th, .saved-articles-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .saved-articles-table th {
            background-color: #f2f2f2;
        }
        .saved-articles-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .saved-articles-table tr:hover {
            background-color: #f5f5f5;
        }
        .action-cell {
            white-space: nowrap;
        }
        
        /* Stili per la lista delle rassegne salvate */
        #saved-reviews-container {
            margin-top: 30px;
            display: none;
        }
        .saved-reviews-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .saved-reviews-table th, .saved-reviews-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .saved-reviews-table th {
            background-color: #f2f2f2;
        }
        .saved-reviews-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .saved-reviews-table tr:hover {
            background-color: #f5f5f5;
        }
        
        /* Stili per il modal della rassegna stampa */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 2% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }
        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-modal:hover {
            color: black;
        }
        
        /* Stili per la visualizzazione della rassegna stampa */
        @media print {
            body * {
                visibility: hidden;
                font-family: 'Times New Roman', Times, serif !important;
            }
            #press-review-modal, #press-review-modal * {
                visibility: visible;
            }
            #view-review-modal, #view-review-modal * {
                visibility: visible;
            }
            #press-review-modal, #view-review-modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                overflow: visible;
                background-color: white;
            }
            #press-review-content, #view-review-content {
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            .modal-header, .modal-buttons, .close-modal {
                display: none !important;
            }
            .press-review-header {
            page-break-after: avoid;
            break-after: avoid;
            page-break-after: avoid;
            text-align: center;
            border-bottom: 2px solid black;
            padding-bottom: 5px;
            margin-bottom: 0;
    }
    
    .press-review-articles {
        column-count: 2 !important; /* Forza il layout a due colonne per la stampa */
        column-gap: 20px;
        margin-top: 0; /* Rimuovi il margine superiore */
    }

   
    
    .modal-content {
        border: none !important; /* Rimuove il bordo durante la stampa per mobile */
    }
        }
        
        #press-review-content, #view-review-content {
            background-color: white;
            font-family: 'Times New Roman', Times, serif;
            padding: 20px;
            margin-top: 20px;
        }

        .press-review-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .press-review-date {
            font-size: 16px;
            margin-bottom: 10px;
        }
      .press-review-articles {
    column-count: 2;
    column-gap: 20px;
    text-align: justify;
    hyphens: auto;
    margin-top: 5px;
}
        .press-review-article::after {
        content: '';
        display: block;
        width: 40%;
        height: 1px;
        background-color: #999;
        margin: 15px auto;
        break-inside: avoid;
        page-break-inside: avoid;
            } 
 /* Aggiungi una riga orizzontale tra gli articoli */
   /* .press-review-article:not(:last-child)::after {
        content: '';
        display: block;
        width: 40%;
        height: 1px;
        background-color: #999;
        margin: 15px auto;
        break-inside: avoid;
        page-break-inside: avoid;
    } */

.press-review-article {
 /*   break-inside: avoid; */
 /*   page-break-inside: avoid; */
    margin-bottom: 10px;
    padding-bottom: 10px;
}
        .article-title {
            font-size: 18px;
            line-height: 1.2; /* Regola questo valore per ridurre l'interlinea */
            font-weight: bold;
            margin-bottom: 5px;
        }
        .article-source {
            font-style: italic;
            margin-bottom: 10px;
            font-size: 14px;
        }
        .article-author {
            font-weight: bold;
            font-size: 14px;
        }
        .article-content {
            font-size: 14px;
            line-height: 1.4;
            text-indent: 20px;
        }
        .article-divider {
    width: 40%;
    height: 1px;
    background-color: #999;
    margin: 15px auto;
    border: none;
}
.article-content p:first-of-type:first-letter {
    font-size: 42px;
    font-weight: bold;
    float: left;
    margin-right: 6px;
    margin-top: 0;
    padding-top: 0;
    line-height: 0.85;
    height: 36px;
}

.article-content p:first-of-type {
    text-indent: 0;  /* Rimuove il rientro dal primo paragrafo */
}

.article-content p {
    text-indent: 20px; /* Mantiene il rientro per gli altri paragrafi */
}
 

.press-review-article:not(:last-child)::after {
    content: '';
    display: block;
    width: 40%;
    height: 1px;
    background-color: #999;
    margin: 15px auto;
}
        /* Rimuove le barre di scorrimento nella stampa */
        @media print {
            html, body {
                overflow: visible !important;
            }
            ::-webkit-scrollbar {
                display: none !important;
            }
            .modal-content {
                overflow: visible !important;
                max-height: none !important;
            }

        }
        .modal-buttons {
            margin-top: 20px;
            text-align: center;
        }
        
        /* Stili per il modal di importazione/esportazione */
        #import-export-modal textarea {
            width: 100%;
            height: 300px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <h1>Fattariellows of the day</h1>
    
    <div class="form-container">
        <input type="url" id="url-input" placeholder="Inserisci l'URL dell'articolo..." required>
        <button id="extract-button">Estrai Articolo</button>
    </div>
    
    <div id="status-message"></div>
    
    <div id="extraction-results">
        <div class="field-container">
            <label class="field-label" for="title-field">Titolo:</label>
            <input type="text" id="title-field">
        </div>
        
        <div class="field-container">
            <label class="field-label" for="author-field">Autore:</label>
            <input type="text" id="author-field">
            <div class="info-text">Può essere modificato se non rilevato correttamente</div>
        </div>
        
        <div class="field-container">
            <label class="field-label" for="url-field">Fonte URL:</label>
            <input type="text" id="url-field">
        </div>
        
        <div class="field-container">
            <label class="field-label" for="source-name-field">Nome della Fonte:</label>
            <input type="text" id="source-name-field" placeholder="es. La Repubblica, Il Corriere della Sera, ecc.">
        </div>
        
        <div class="field-container">
            <label class="field-label" for="content-field">Contenuto dell'Articolo:</label>
            <textarea id="content-field"></textarea>
        </div>
        
        <div class="action-buttons">
            <button id="save-article-btn">Salva Articolo</button>
            <button id="cancel-extraction-btn">Annulla</button>
        </div>
    </div>
    
    <div id="saved-articles-container">
        <h2>Articoli Salvati</h2>
        <p>Da qui puoi gestire gli articoli salvati e generare la rassegna stampa.</p>
        
        <div class="action-buttons">
            <button id="generate-press-review-btn">Genera Rassegna Stampa</button>
            <button id="export-data-btn">Esporta Dati</button>
            <button id="import-data-btn">Importa Dati</button>
            <button id="reset-data-btn">Elimina Tutti</button>
        </div>
        <br>
        <table class="saved-articles-table" id="saved-articles-table">
            <thead>
                <tr>
                    <th>Titolo</th>
                    <th>Fonte</th>
                    <th>Autore</th>
                    <th>Azioni</th>
                </tr>
            </thead>
            <tbody id="saved-articles-body">
                <!-- Gli articoli salvati verranno inseriti qui dinamicamente -->
            </tbody>
        </table>
    </div>
    
    <!-- Container per le rassegne stampa salvate -->
    <div id="saved-reviews-container">
        <h2>Rassegne Stampa Salvate</h2>
        <p>Qui puoi visualizzare, scaricare o eliminare le rassegne stampa che hai generato.</p>
        
        <table class="saved-reviews-table" id="saved-reviews-table">
            <thead>
                <tr>
                    <th>Titolo</th>
                    <th>Data</th>
                    <th>N° Articoli</th>
                    <th>Azioni</th>
                </tr>
            </thead>
            <tbody id="saved-reviews-body">
                <!-- Le rassegne salvate verranno inserite qui dinamicamente -->
            </tbody>
        </table>
    </div>
    
    <!-- Modal per la rassegna stampa -->
    <div id="press-review-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" id="close-press-review">&times;</span>
                <h2>Anteprima Rassegna Stampa</h2>
            </div>
            <div id="press-review-content">
                <!-- Il contenuto della rassegna stampa verrà inserito qui dinamicamente -->
            </div>
            <div class="modal-buttons">
                <button id="print-press-review-btn">Stampa PDF</button>
                <button id="save-press-review-btn">Salva Rassegna</button>
                <button id="close-press-review-btn">Chiudi</button>
            </div>
        </div>
    </div>
    
    <!-- Modal per visualizzare le rassegne salvate -->
    <div id="view-review-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" id="close-view-review">&times;</span>
                <h2>Visualizza Rassegna Stampa</h2>
            </div>
            <div id="view-review-content">
                <!-- Il contenuto della rassegna salvata verrà inserito qui dinamicamente -->
            </div>
            <div class="modal-buttons">
                <button id="print-saved-review-btn">Stampa PDF</button>
                <button id="close-view-review-btn">Chiudi</button>
            </div>
        </div>
    </div>
    
    <!-- Modal per import/export -->
    <div id="import-export-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span class="close-modal" id="close-import-export">&times;</span>
                <h2 id="import-export-title">Esporta Dati</h2>
            </div>
            <p id="import-export-description">Copia i dati sottostanti o salvali in un file CSV per backup.</p>
            <textarea id="import-export-textarea"></textarea>
            <div class="modal-buttons">
                <button id="copy-export-btn">Copia negli Appunti</button>
                <button id="confirm-import-btn">Importa</button>
                <button id="download-csv-btn">Scarica CSV</button>
                <button id="close-import-export-btn">Chiudi</button>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementi DOM
            const urlInput = document.getElementById('url-input');
            const extractButton = document.getElementById('extract-button');
            const extractionResults = document.getElementById('extraction-results');
            const statusMessage = document.getElementById('status-message');
            const titleField = document.getElementById('title-field');
            const authorField = document.getElementById('author-field');
            const urlField = document.getElementById('url-field');
            const sourceNameField = document.getElementById('source-name-field');
            const contentField = document.getElementById('content-field');
            const saveArticleBtn = document.getElementById('save-article-btn');
            const cancelExtractionBtn = document.getElementById('cancel-extraction-btn');
            const savedArticlesContainer = document.getElementById('saved-articles-container');
            const savedArticlesBody = document.getElementById('saved-articles-body');
            const generatePressReviewBtn = document.getElementById('generate-press-review-btn');
            const exportDataBtn = document.getElementById('export-data-btn');
            const importDataBtn = document.getElementById('import-data-btn');
            const resetDataBtn = document.getElementById('reset-data-btn');
            
            // Modal per la rassegna stampa
            const pressReviewModal = document.getElementById('press-review-modal');
            const closePressReview = document.getElementById('close-press-review');
            const pressReviewContent = document.getElementById('press-review-content');
            const printPressReviewBtn = document.getElementById('print-press-review-btn');
            const savePressReviewBtn = document.getElementById('save-press-review-btn');
            const closePressReviewBtn = document.getElementById('close-press-review-btn');
            
            // Modal per import/export
            const importExportModal = document.getElementById('import-export-modal');
            const closeImportExport = document.getElementById('close-import-export');
            const importExportTitle = document.getElementById('import-export-title');
            const importExportDescription = document.getElementById('import-export-description');
            const importExportTextarea = document.getElementById('import-export-textarea');
            const copyExportBtn = document.getElementById('copy-export-btn');
            const confirmImportBtn = document.getElementById('confirm-import-btn');
            const downloadCsvBtn = document.getElementById('download-csv-btn');
            const closeImportExportBtn = document.getElementById('close-import-export-btn');
            
            // Array per memorizzare gli articoli
            let savedArticles = [];
            // Array per memorizzare le rassegne stampa
            let savedPressReviews = [];
            // Oggetto per l'articolo corrente in fase di modifica
            let currentEditArticle = null;
            
            // Carica gli articoli salvati dal localStorage
            loadSavedData();
            
            // Event listener per l'estrazione dell'articolo
            extractButton.addEventListener('click', function() {
                const url = urlInput.value.trim();
                
                if (!url) {
                    showStatus('error', 'Per favore, inserisci un URL valido.');
                    return;
                }
                
                // Nascondi i risultati precedenti e mostra lo stato di caricamento
                extractionResults.style.display = 'none';
                showStatus('loading', 'Estrazione in corso...');
                
                // Utilizziamo un proxy CORS per aggirare le restrizioni di sicurezza
                const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(url);
                
                fetch(proxyUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Errore durante il recupero della pagina web');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Crea un elemento DOM temporaneo per analizzare l'HTML
                        const tempEl = document.createElement('div');
                        tempEl.innerHTML = data.contents;
                        
                        // Estrai le informazioni dell'articolo
                        const articleInfo = extractArticleInfo(tempEl, url);
                        
                        // Popola i campi
                        titleField.value = articleInfo.title;
                        authorField.value = articleInfo.author;
                        urlField.value = url;
                        
                        // Tenta di estrarre il nome della fonte dall'URL
                        try {
                            const hostname = new URL(url).hostname;
                            const domainParts = hostname.split('.');
                            if (domainParts.length >= 2) {
                                const domain = domainParts[domainParts.length - 2];
                                // Capitalizza il nome del dominio e rimuovi eventuali trattini
                                sourceNameField.value = domain.charAt(0).toUpperCase() + 
                                                     domain.slice(1).replace(/-/g, ' ');
                            }
                        } catch (e) {
                            sourceNameField.value = '';
                        }
                        
                        contentField.value = articleInfo.rawContent;
                        
                        // Resetta eventuali modifiche in corso
                        currentEditArticle = null;
                        
                        // Mostra i risultati e nascondi lo stato di caricamento
                        extractionResults.style.display = 'block';
                        showStatus('success', 'Estrazione completata! Modifica i campi se necessario e salva l\'articolo.');
                    })
                    .catch(error => {
                        showStatus('error', `Errore: ${error.message}`);
                    });
            });
            
            // Event listener per salvare l'articolo
            saveArticleBtn.addEventListener('click', function() {
                const title = titleField.value.trim();
                const author = authorField.value.trim();
                const url = urlField.value.trim();
                const sourceName = sourceNameField.value.trim();
                const content = contentField.value.trim();
                
                if (!title) {
                    showStatus('error', 'Il titolo è obbligatorio.');
                    return;
                }
                
                if (!content) {
                    showStatus('error', 'Il contenuto dell\'articolo è obbligatorio.');
                    return;
                }
                
                // Se stiamo modificando un articolo esistente
                if (currentEditArticle) {
                    const index = savedArticles.findIndex(article => article.id === currentEditArticle.id);
                    if (index !== -1) {
                        savedArticles[index] = {
                            ...savedArticles[index],
                            title,
                            author,
                            url,
                            sourceName,
                            content,
                            modifiedDate: new Date().toISOString()
                        };
                        showStatus('success', 'Articolo aggiornato con successo!');
                    }
                } else {
                    // Crea un nuovo articolo
                    const newArticle = {
                        id: generateUniqueId(),
                        title,
                        author,
                        url,
                        sourceName,
                        content,
                        createdDate: new Date().toISOString(),
                        modifiedDate: new Date().toISOString()
                    };
                    
                    savedArticles.push(newArticle);
                    showStatus('success', 'Articolo salvato con successo!');
                }
                
                // Salva gli articoli nel localStorage
                saveArticlesToLocalStorage();
                
                // Aggiorna la tabella degli articoli
                updateSavedArticlesTable();
                
                // Mostra il container degli articoli salvati
                savedArticlesContainer.style.display = 'block';
                
                // Nascondi i risultati dell'estrazione
                extractionResults.style.display = 'none';
                
                // Resetta i campi
                resetExtractionFields();
            });
            
            // Event listener per annullare l'estrazione
            cancelExtractionBtn.addEventListener('click', function() {
                extractionResults.style.display = 'none';
                statusMessage.textContent = '';
                currentEditArticle = null;
                resetExtractionFields();
            });
            
            // Event listener per generare la rassegna stampa
            generatePressReviewBtn.addEventListener('click', function() {
                if (savedArticles.length === 0) {
                    showStatus('error', 'Non ci sono articoli salvati per generare una rassegna stampa.');
                    return;
                }
                
                // Genera la rassegna stampa
                generatePressReview();
                
                // Mostra il modal
                pressReviewModal.style.display = 'block';
            });
            
            // Event listener per esportare i dati
            exportDataBtn.addEventListener('click', function() {
                prepareExport();
                importExportModal.style.display = 'block';
            });
            
            // Event listener per importare i dati
            importDataBtn.addEventListener('click', function() {
                prepareImport();
                importExportModal.style.display = 'block';
            });
            
            // Event listener per il reset dei dati
            resetDataBtn.addEventListener('click', function() {
                if (confirm('Sei sicuro di voler eliminare tutti gli articoli salvati? Questa azione non può essere annullata.')) {
                    savedArticles = [];
                    saveArticlesToLocalStorage();
                    updateSavedArticlesTable();
                    showStatus('success', 'Tutti gli articoli sono stati eliminati.');
                }
            });
            
            // Event listener per la stampa della rassegna
            printPressReviewBtn.addEventListener('click', function() {
                window.print();
            });
            
            // Event listener per salvare la rassegna
            savePressReviewBtn.addEventListener('click', function() {
                // Salva la rassegna attuale
                const currentDate = new Date();
                const reviewId = generateUniqueId();
                const reviewTitle = `Fattariellows of the day ${formatDate(currentDate)}`;
                
                const reviewData = {
                    id: reviewId,
                    title: reviewTitle,
                    date: currentDate.toISOString(),
                    articles: savedArticles.map(article => article.id),
                    htmlContent: pressReviewContent.innerHTML
                };
                
                savedPressReviews.push(reviewData);
                saveReviewsToLocalStorage();
                
                // Aggiorna la visualizzazione delle rassegne salvate
                updateSavedReviewsList();
                
                showStatus('success', 'Rassegna stampa salvata con successo!');
                pressReviewModal.style.display = 'none';
            });
            
            // Event listeners per chiudere i modal
            closePressReview.addEventListener('click', function() {
                pressReviewModal.style.display = 'none';
            });
            
            closePressReviewBtn.addEventListener('click', function() {
                pressReviewModal.style.display = 'none';
            });
            
            closeImportExport.addEventListener('click', function() {
                importExportModal.style.display = 'none';
            });
            
            closeImportExportBtn.addEventListener('click', function() {
                importExportModal.style.display = 'none';
            });
            
            // Event listener per copiare i dati esportati
            copyExportBtn.addEventListener('click', function() {
                importExportTextarea.select();
                document.execCommand('copy');
                showStatus('success', 'Dati copiati negli appunti!');
            });
            
            // Event listener per confermare l'importazione
            confirmImportBtn.addEventListener('click', function() {
                const importData = importExportTextarea.value.trim();
                if (!importData) {
                    showStatus('error', 'Nessun dato da importare.');
                    return;
                }
                
                try {
                    // Tenta di analizzare i dati come CSV
                    const importedArticles = parseCSV(importData);
                    
                    if (importedArticles && importedArticles.length > 0) {
                        // Chiedi conferma prima di sovrascrivere o aggiungere
                        const confirmAction = confirm('Vuoi sovrascrivere gli articoli esistenti (OK) o aggiungerli a quelli attuali (Annulla)?');
                        
                        if (confirmAction) {
                            // Sovrascrive gli articoli esistenti
                            savedArticles = importedArticles;
                        } else {
                            // Aggiunge gli articoli importati a quelli esistenti
                            savedArticles = [...savedArticles, ...importedArticles];
                        }
                        
                        saveArticlesToLocalStorage();
                        updateSavedArticlesTable();
                        importExportModal.style.display = 'none';
                        showStatus('success', `Importati ${importedArticles.length} articoli con successo!`);
                    } else {
                        showStatus('error', 'Nessun articolo valido trovato nei dati importati.');
                    }
                } catch (error) {
                    showStatus('error', `Errore durante l'importazione: ${error.message}`);
                }
            });
            
            // Event listener per scaricare i dati come CSV
            downloadCsvBtn.addEventListener('click', function() {
                const csv = importExportTextarea.value;
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `rassegna_stampa_export_${formatDateFileName(new Date())}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            
            // Quando si clicca fuori dal modal, chiudilo
            window.addEventListener('click', function(event) {
                if (event.target === pressReviewModal) {
                    pressReviewModal.style.display = 'none';
                }
                if (event.target === importExportModal) {
                    importExportModal.style.display = 'none';
                }
            });
            
            // Funzione per mostrare messaggi di stato
            function showStatus(type, message) {
                statusMessage.textContent = message;
                statusMessage.className = '';
                
                if (type === 'error') {
                    statusMessage.classList.add('error');
                } else if (type === 'success') {
                    statusMessage.classList.add('success');
                } else if (type === 'loading') {
                    statusMessage.classList.add('loading');
                }
            }
            
            // Funzione per estrarre le informazioni dell'articolo
            function extractArticleInfo(domElement, url) {
                // Oggetto che conterrà tutte le informazioni estratte
                const articleInfo = {
                    title: '',
                    author: '',
                    content: '',
                    rawContent: ''
                };
                
                // Estrai il titolo
                articleInfo.title = extractTitle(domElement);
                
                // Estrai l'autore
                articleInfo.author = extractAuthor(domElement);
                
                // Estrai il contenuto dell'articolo
                const contentResult = extractArticleContent(domElement);
                articleInfo.content = contentResult.formattedContent;
                articleInfo.rawContent = contentResult.rawContent;
                
                return articleInfo;
            }
            
            // Funzione per estrarre il titolo
            function extractTitle(domElement) {
                // Strategia 1: Cerca il tag title
                const titleTag = domElement.querySelector('title');
                if (titleTag && titleTag.textContent.trim()) {
                    // Pulisci il titolo (rimuovi il nome del sito se presente)
                    let title = titleTag.textContent.trim();
                    // Rimuovi parti comuni alla fine del titolo come " | Nome del sito"
                    title = title.split(/\s[|\-–—]\s/)[0];
                    return title;
                }
                
                // Strategia 2: Cerca l'elemento h1
                const h1Tags = domElement.querySelectorAll('h1');
                if (h1Tags.length > 0) {
                    // Prendi l'h1 più lungo come probabile titolo
                    let longestH1 = '';
                    for (const h1 of h1Tags) {
                        const text = h1.textContent.trim();
                        if (text.length > longestH1.length) {
                            longestH1 = text;
                        }
                    }
                    if (longestH1) return longestH1;
                }
                
                // Strategia 3: Cerca meta tags
                const metaTitleTag = domElement.querySelector('meta[property="og:title"], meta[name="twitter:title"]');
                if (metaTitleTag && metaTitleTag.getAttribute('content')) {
                    return metaTitleTag.getAttribute('content').trim();
                }
                
                // Strategia 4: Cerca elementi con classe o id che contengono "title"
                const titleElements = domElement.querySelectorAll('[class*="title"], [id*="title"], .headline, .heading');
                if (titleElements.length > 0) {
                    for (const el of titleElements) {
                        const text = el.textContent.trim();
                        if (text.length > 10 && text.length < 200) {
                            return text;
                        }
                    }
                }
                
                return 'Titolo non trovato';
            }
            
            // Funzione per estrarre l'autore
            function extractAuthor(domElement) {
                // Strategia 1: Cerca meta tags per l'autore
                const metaAuthorTag = domElement.querySelector('meta[name="author"], meta[property="article:author"], meta[name="twitter:creator"]');
                if (metaAuthorTag && metaAuthorTag.getAttribute('content')) {
                    return metaAuthorTag.getAttribute('content').trim();
                }
                
                // Strategia 2: Cerca elementi con classe o id che contengono "author"
                const authorSelectors = [
                    '[class*="author"]', 
                    '[id*="author"]', 
                    '[rel="author"]',
                    '.byline',
                    '.writer',
                    '[class*="byline"]',
                    '[class*="by-"]'
                ];
                
                const authorElements = domElement.querySelectorAll(authorSelectors.join(', '));
                if (authorElements.length > 0) {
                    for (const el of authorElements) {
                        const text = el.textContent.trim();
                        // Evita testi troppo lunghi o troppo corti
                        if (text.length > 3 && text.length < 100) {
                            // Cerca di pulire il testo (rimuovere "By", "Author:", ecc.)
                            let cleanedText = text.replace(/^(by|author|written by|posted by)[\s:]+/i, '').trim();
                            // Se il testo è ancora valido, restituiscilo
                            if (cleanedText.length > 3) {
                                return cleanedText;
                            }
                        }
                    }
                }
                
                // Strategia 3: Cerca schemi strutturati (Schema.org)
                const personElements = domElement.querySelectorAll('[itemtype*="schema.org/Person"]');
                if (personElements.length > 0) {
                    for (const el of personElements) {
                        const nameEl = el.querySelector('[itemprop="name"]');
                        if (nameEl && nameEl.textContent.trim()) {
                            return nameEl.textContent.trim();
                        }
                    }
                }
                
                return '';
            }
            
            // Funzione per estrarre il contenuto dell'articolo
            function extractArticleContent(domElement) {
                // Risultato dell'estrazione
                const result = {
                    formattedContent: '',
                    rawContent: ''
                };
                
                // Strategia 1: Cerca elementi con tag semantici per articoli
                let contentElement = null;
                
                // Cerca l'elemento article
                const articleElements = domElement.querySelectorAll('article');
                if (articleElements.length > 0) {
                    // Prendi l'elemento article più grande
                    let largestArticle = articleElements[0];
                    let maxLength = articleElements[0].textContent.length;
                    
                    for (let i = 1; i < articleElements.length; i++) {
                        const length = articleElements[i].textContent.length;
                        if (length > maxLength) {
                            maxLength = length;
                            largestArticle = articleElements[i];
                        }
                    }
                    
                    contentElement = largestArticle;
                }
                
                // Se non è stato trovato un elemento article valido, cerca nella sezione principale
                if (!contentElement || contentElement.textContent.trim().length < 100) {
                    const mainElements = domElement.querySelectorAll('main');
                    if (mainElements.length > 0) {
                        contentElement = mainElements[0];
                    }
                }
                
                // Se non è stato trovato né article né main, cerca div con classi o ID comuni per articoli
                if (!contentElement || contentElement.textContent.trim().length < 100) {
                    const potentialContainers = domElement.querySelectorAll('div[class*="article"], div[class*="content"], div[class*="post"], div[id*="article"], div[id*="content"], div[id*="post"], [itemprop="articleBody"]');
                    if (potentialContainers.length > 0) {
                        // Prendi il container più grande che è probabile contenga l'articolo
                        let largestContainer = potentialContainers[0];
                        let maxLength = largestContainer.textContent.length;
                        
                        for (let i = 1; i < potentialContainers.length; i++) {
                            const currentLength = potentialContainers[i].textContent.length;
                            if (currentLength > maxLength) {
                                maxLength = currentLength;
                                largestContainer = potentialContainers[i];
                            }
                        }
                        
                        contentElement = largestContainer;
                    }
                }
                
                // Se abbiamo trovato un elemento di contenuto, estraiamo il testo
                if (contentElement && contentElement.textContent.trim().length > 100) {
                    result.formattedContent = cleanAndFormatContent(contentElement);
                    result.rawContent = extractRawText(contentElement);
                    return result;
                }
                
                // Strategia 4: Come ultima risorsa, cerca paragrafi lunghi
                const paragraphs = domElement.querySelectorAll('p');
                if (paragraphs.length > 0) {
                    // Filtra i paragrafi che sono probabilmente parte dell'articolo
                    const contentParagraphs = Array.from(paragraphs).filter(p => {
                        const text = p.textContent.trim();
                        return text.length > 80 && text.split(' ').length > 15;
                    });
                    
                    if (contentParagraphs.length > 0) {
                        result.formattedContent = contentParagraphs.map(p => `<p>${p.textContent}</p>`).join('');
                        result.rawContent = contentParagraphs.map(p => p.textContent).join('\n\n');
                        return result;
                    }
                }
                
                // Fallback: Prendi tutto il testo del body
                const bodyText = domElement.querySelector('body').textContent.trim();
                result.formattedContent = 'Impossibile identificare chiaramente il contenuto dell\'articolo.';
                result.rawContent = 'Impossibile identificare chiaramente il contenuto dell\'articolo.';
                return result;
            }
            
            // Funzione per pulire e formattare il contenuto
            function cleanAndFormatContent(element) {
                // Clona l'elemento per non modificare l'originale
                const clone = element.cloneNode(true);
                
                // Rimuovi elementi che non sono generalmente parte del contenuto
                const elementsToRemove = [
                    'script', 'style', 'nav', 'header', 'footer', 'aside', 'iframe', 'form', 
                    '.comments', '.sidebar', '.ad', '.advertisement', '.banner', '.share', '.social',
                    '.related', '.recommended', 'figcaption', '.caption', '.newsletter'
                ];
                
                elementsToRemove.forEach(selector => {
                    const elements = clone.querySelectorAll(selector);
                    elements.forEach(el => el.remove());
                });
                
                // Estrai il testo formattato mantenendo paragrafi e titoli
                let result = '';
                const contentElements = clone.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, blockquote');
                
                contentElements.forEach(el => {
                    const tagName = el.tagName.toLowerCase();
                    const text = el.textContent.trim();
                    
                    if (text.length > 0) {
                        if (tagName.startsWith('h')) {
                            result += `<${tagName}>${text}</${tagName}>`;
                        } else if (tagName === 'li') {
                            result += `<li>${text}</li>`;
                        } else if (tagName === 'blockquote') {
                            result += `<blockquote>${text}</blockquote>`;
                        } else {
                            result += `<p>${text}</p>`;
                        }
                    }
                });
                
                // Se non ci sono elementi formattati, prendi tutto il testo
                if (result.trim() === '') {
                    result = `<p>${clone.textContent.trim().replace(/[\n\r]+/g, '</p><p>').replace(/\s{2,}/g, ' ')}</p>`;
                }
                
                return result;
            }
            
            // Funzione per estrarre il testo raw
            function extractRawText(element) {
                // Clona l'elemento per non modificare l'originale
                const clone = element.cloneNode(true);
                
                // Rimuovi elementi che non sono generalmente parte del contenuto
                const elementsToRemove = [
                    'script', 'style', 'nav', 'header', 'footer', 'aside', 'iframe', 'form', 
                    '.comments', '.sidebar', '.ad', '.advertisement', '.banner', '.share', '.social',
                    '.related', '.recommended', 'figcaption', '.caption', '.newsletter'
                ];
                
                elementsToRemove.forEach(selector => {
                    const elements = clone.querySelectorAll(selector);
                    elements.forEach(el => el.remove());
                });
                
                // Estrai paragrafi e titoli
                const paragraphs = [];
                const contentElements = clone.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, blockquote');
                
                contentElements.forEach(el => {
                    const tagName = el.tagName.toLowerCase();
                    const text = el.textContent.trim();
                    
                    if (text.length > 0) {
                        if (tagName.startsWith('h')) {
                            // Aggiungi spazio extra per i titoli
                            paragraphs.push(text + "\n");
                        } else {
                            paragraphs.push(text);
                        }
                    }
                });
                
                // Se non ci sono elementi, prendi tutto il testo
                if (paragraphs.length === 0) {
                    return clone.textContent.trim()
                        .replace(/[\n\r]+/g, '\n\n')
                        .replace(/\s{2,}/g, ' ');
                }
                
                return paragraphs.join('\n\n');
            }
            
            // Funzione per aggiornare la tabella degli articoli salvati
            function updateSavedArticlesTable() {
                // Mostra il container degli articoli salvati se ci sono articoli
                if (savedArticles.length > 0) {
                    savedArticlesContainer.style.display = 'block';
                    
                    // Pulisci la tabella
                    savedArticlesBody.innerHTML = '';
                    
                    // Ordina gli articoli per data di creazione (più recenti prima)
                    const sortedArticles = [...savedArticles].sort((a, b) => 
                        new Date(b.createdDate) - new Date(a.createdDate)
                    );
                    
                    // Aggiungi le righe per ogni articolo
                    sortedArticles.forEach(article => {
                        const row = document.createElement('tr');
                        
                        const titleCell = document.createElement('td');
                        titleCell.textContent = article.title;
                        row.appendChild(titleCell);
                        
                        const sourceCell = document.createElement('td');
                        sourceCell.textContent = article.sourceName || 'N/A';
                        row.appendChild(sourceCell);
                        
                        const authorCell = document.createElement('td');
                        authorCell.textContent = article.author || 'N/A';
                        row.appendChild(authorCell);
                        
                        const actionsCell = document.createElement('td');
                        actionsCell.className = 'action-cell';
                        
                        // Pulsante Modifica
                        const editBtn = document.createElement('button');
                        editBtn.textContent = 'Modifica';
                        editBtn.addEventListener('click', () => editArticle(article.id));
                        actionsCell.appendChild(editBtn);
                        
                        // Pulsante Elimina
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Elimina';
                        deleteBtn.style.backgroundColor = '#f44336';
                        deleteBtn.addEventListener('click', () => deleteArticle(article.id));
                        actionsCell.appendChild(deleteBtn);
                        
                        row.appendChild(actionsCell);
                        
                        savedArticlesBody.appendChild(row);
                    });
                    
                    // Mostra o nascondi il pulsante di generazione rassegna stampa
                    generatePressReviewBtn.style.display = savedArticles.length > 0 ? 'inline-block' : 'none';
                } else {
                    savedArticlesBody.innerHTML = '<tr><td colspan="4">Nessun articolo salvato.</td></tr>';
                    generatePressReviewBtn.style.display = 'none';
                }
            }
            
            // Funzione per modificare un articolo
            function editArticle(articleId) {
                const article = savedArticles.find(a => a.id === articleId);
                if (!article) return;
                
                // Popola i campi con i dati dell'articolo
                titleField.value = article.title;
                authorField.value = article.author || '';
                urlField.value = article.url || '';
                sourceNameField.value = article.sourceName || '';
                contentField.value = article.content;
                
                // Salva riferimento all'articolo corrente
                currentEditArticle = article;
                
                // Mostra i risultati dell'estrazione
                extractionResults.style.display = 'block';
                
                // Scorrimento verso l'alto
                window.scrollTo(0, 0);
                
                showStatus('success', 'Modifica l\'articolo e salva le modifiche.');
            }
            
            // Funzione per eliminare un articolo
            function deleteArticle(articleId) {
                if (confirm('Sei sicuro di voler eliminare questo articolo?')) {
                    // Rimuovi l'articolo dall'array
                    savedArticles = savedArticles.filter(a => a.id !== articleId);
                    
                    // Aggiorna il localStorage
                    saveArticlesToLocalStorage();
                    
                    // Aggiorna la tabella
                    updateSavedArticlesTable();
                    
                    showStatus('success', 'Articolo eliminato con successo.');
                }
            }
            
            // Funzione per generare la rassegna stampa
function generatePressReview() {
    const currentDate = new Date();
    const formattedDate = formatDate(currentDate);
    
    // Crea l'intestazione della rassegna stampa
    let reviewHTML = `
       <div class="press-review-header">
            <div class="press-review-title">Fattariellows of the day</div>
            <div class="press-review-date">${formattedDate}</div>
        </div>
        <div class="press-review-articles">
    `;
    
    
    // Aggiungi ogni articolo
    savedArticles.forEach((article, index) => {
        reviewHTML += `
            <div class="press-review-article">
                <div class="article-title">${article.title}</div>
                <div class="article-source">${article.sourceName || 'Fonte sconosciuta'}</div>
                ${article.author ? `<div class="article-author">${article.author}</div>` : ''}
                <div class="article-content">
                    ${formatArticleForReview(article.content)}
                </div>
            </div>
        `;
 /*  if (index < savedArticles.length - 1) {
            reviewHTML += `<hr class="article-divider">`;
        } */
    });
    
    reviewHTML += '</div>'; // Chiudi press-review-articles
    
    // Imposta il contenuto nel modal
    pressReviewContent.innerHTML = reviewHTML;
}
            
            // Funzione per formattare l'articolo per la rassegna
            function formatArticleForReview(content) {
                // Se il contenuto è già in HTML, mantienilo come tale
                if (content.includes('<p>') || content.includes('<h')) {
                    return content;
                }
                
                // Altrimenti, converti le interruzioni di riga in paragrafi
                return content.split('\n\n')
                    .map(paragraph => paragraph.trim())
                    .filter(paragraph => paragraph.length > 0)
                    .map(paragraph => `<p>${paragraph}</p>`)
                    .join('');
            }
            
            // Funzione per prepararsi all'esportazione dei dati
            function prepareExport() {
                // Nasconde/mostra i pulsanti appropriati
                confirmImportBtn.style.display = 'none';
                copyExportBtn.style.display = 'inline-block';
                downloadCsvBtn.style.display = 'inline-block';
                
                // Imposta il titolo e la descrizione
                importExportTitle.textContent = 'Esporta Dati';
                importExportDescription.textContent = 'Copia i dati sottostanti o salvali in un file CSV per backup.';
                
                // Genera il CSV
                const csvContent = generateCSV();
                importExportTextarea.value = csvContent;
            }
            
            // Funzione per prepararsi all'importazione dei dati
            function prepareImport() {
                // Nasconde/mostra i pulsanti appropriati
                confirmImportBtn.style.display = 'inline-block';
                copyExportBtn.style.display = 'none';
                downloadCsvBtn.style.display = 'none';
                
                // Imposta il titolo e la descrizione
                importExportTitle.textContent = 'Importa Dati';
                importExportDescription.textContent = 'Incolla qui i dati CSV da importare.';
                
                // Pulisci l'area di testo
                importExportTextarea.value = '';
            }
            
            // Funzione per generare CSV dagli articoli
            function generateCSV() {
                // Intestazioni CSV
                const headers = ['id', 'title', 'author', 'sourceName', 'url', 'content', 'createdDate', 'modifiedDate'];
                
                // Crea la riga di intestazione
                let csv = headers.join(',') + '\n';
                
                // Aggiungi ogni articolo
                savedArticles.forEach(article => {
                    const row = headers.map(header => {
                        // Gestisci i campi di testo con virgole o virgolette
                        if (typeof article[header] === 'string') {
                            // Sostituisci le virgolette con doppia virgoletta (standard CSV)
                            const escaped = article[header].replace(/"/g, '""');
                            // Racchiudi tra virgolette per gestire virgole e interruzioni di riga
                            return `"${escaped}"`;
                        }
                        return article[header] || '';
                    });
                    
                    csv += row.join(',') + '\n';
                });
                
                return csv;
            }
            
            // Funzione per analizzare dati CSV
            function parseCSV(csvData) {
                const rows = csvData.split('\n');
                const headers = rows[0].split(',').map(h => h.trim().replace(/"/g, ''));
                
                // Verifica che i dati contengano le intestazioni necessarie
                const requiredHeaders = ['title', 'content'];
                const hasRequiredHeaders = requiredHeaders.every(header => 
                    headers.includes(header)
                );
                
                if (!hasRequiredHeaders) {
                    throw new Error('Il formato CSV non è valido. Mancano intestazioni obbligatorie.');
                }
                
                const articles = [];
                
                // Analizza le righe di dati (salta l'intestazione)
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i].trim();
                    if (!row) continue; // Salta righe vuote
                    
                    // Gestisce valori tra virgolette contenenti virgole
                    let values = [];
                    let inQuotes = false;
                    let currentValue = '';
                    
                    for (let j = 0; j < row.length; j++) {
                        const char = row[j];
                        
                        if (char === '"') {
                            if (j < row.length - 1 && row[j + 1] === '"') {
                                // Gestisce le virgolette doppie escape
                                currentValue += '"';
                                j++; // Salta il carattere successivo
                            } else {
                                inQuotes = !inQuotes;
                            }
                        } else if (char === ',' && !inQuotes) {
                            values.push(currentValue);
                            currentValue = '';
                        } else {
                            currentValue += char;
                        }
                    }
                    
                    // Aggiungi l'ultimo valore
                    values.push(currentValue);
                    
                    // Crea un oggetto articolo con i valori analizzati
                    const article = {};
                    headers.forEach((header, index) => {
                        if (index < values.length) {
                            article[header] = values[index];
                        } else {
                            article[header] = '';
                        }
                    });
                    
                    // Verifica che l'articolo abbia i campi obbligatori
                    if (article.title && article.content) {
                        // Assicurati che ogni articolo abbia un ID unico
                        if (!article.id) {
                            article.id = generateUniqueId();
                        }
                        // Imposta date se mancanti
                        if (!article.createdDate) {
                            article.createdDate = new Date().toISOString();
                        }
                        if (!article.modifiedDate) {
                            article.modifiedDate = new Date().toISOString();
                        }
                        
                        articles.push(article);
                    }
                }
                
                return articles;
            }
            
            // Funzione per generare un ID unico
            function generateUniqueId() {
                return Date.now().toString(36) + Math.random().toString(36).substring(2);
            }
            
            // Funzione per formattare la data
            function formatDate(date) {
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                return date.toLocaleDateString('it-IT', options);
            }
            
            // Funzione per formattare la data nel nome del file
            function formatDateFileName(date) {
                return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
            }
            
            // Funzione per salvare gli articoli nel localStorage
            function saveArticlesToLocalStorage() {
                localStorage.setItem('savedArticles', JSON.stringify(savedArticles));
            }
            
            // Funzione per salvare le rassegne nel localStorage
            function saveReviewsToLocalStorage() {
                localStorage.setItem('savedPressReviews', JSON.stringify(savedPressReviews));
            }
            
            // Funzione per caricare i dati salvati dal localStorage
            function loadSavedData() {
                // Carica gli articoli
                const savedArticlesJson = localStorage.getItem('savedArticles');
                if (savedArticlesJson) {
                    try {
                        savedArticles = JSON.parse(savedArticlesJson);
                        updateSavedArticlesTable();
                    } catch (e) {
                        console.error('Errore nel caricamento degli articoli salvati:', e);
                    }
                }
                
                // Carica le rassegne
                const savedReviewsJson = localStorage.getItem('savedPressReviews');
                if (savedReviewsJson) {
                    try {
                        savedPressReviews = JSON.parse(savedReviewsJson);
                    } catch (e) {
                        console.error('Errore nel caricamento delle rassegne salvate:', e);
                    }
                }
            }
            
            // Funzione per resettare i campi di estrazione
            function resetExtractionFields() {
                titleField.value = '';
                authorField.value = '';
                urlField.value = '';
                sourceNameField.value = '';
                contentField.value = '';
            }
            
            // Modal per visualizzare le rassegne salvate
            const viewReviewModal = document.getElementById('view-review-modal');
            const closeViewReview = document.getElementById('close-view-review');
            const viewReviewContent = document.getElementById('view-review-content');
            const printSavedReviewBtn = document.getElementById('print-saved-review-btn');
            const closeViewReviewBtn = document.getElementById('close-view-review-btn');
            
            // Chiusura del modal di visualizzazione rassegna
            closeViewReview.addEventListener('click', function() {
                viewReviewModal.style.display = 'none';
            });
            
            closeViewReviewBtn.addEventListener('click', function() {
                viewReviewModal.style.display = 'none';
            });
            
            // Stampa della rassegna salvata
            printSavedReviewBtn.addEventListener('click', function() {
                // Rimuove temporaneamente i bordi del modal per la stampa
                const modalContent = viewReviewModal.querySelector('.modal-content');
                const originalBorder = modalContent.style.border;
                modalContent.style.border = 'none';
                
                // Nasconde le barre di scorrimento
                document.body.style.overflow = 'hidden';
                modalContent.style.overflow = 'hidden';
                
                // Usa la funzione di stampa del browser
                window.print();
                
                // Ripristina i bordi e le barre di scorrimento
                setTimeout(() => {
                    modalContent.style.border = originalBorder;
                    document.body.style.overflow = '';
                    modalContent.style.overflow = 'auto';
                }, 1000);
            });
            
            // Funzione per aggiornare la lista delle rassegne salvate
            function updateSavedReviewsList() {
                const savedReviewsContainer = document.getElementById('saved-reviews-container');
                const savedReviewsBody = document.getElementById('saved-reviews-body');
                
                // Mostra il container delle rassegne salvate se ci sono rassegne
                if (savedPressReviews && savedPressReviews.length > 0) {
                    savedReviewsContainer.style.display = 'block';
                    
                    // Pulisci la tabella
                    savedReviewsBody.innerHTML = '';
                    
                    // Ordina le rassegne per data (più recenti prima)
                    const sortedReviews = [...savedPressReviews].sort((a, b) => 
                        new Date(b.date) - new Date(a.date)
                    );
                    
                    // Aggiungi le righe per ogni rassegna
                    sortedReviews.forEach(review => {
                        const row = document.createElement('tr');
                        
                        const titleCell = document.createElement('td');
                        titleCell.textContent = review.title;
                        row.appendChild(titleCell);
                        
                        const dateCell = document.createElement('td');
                        dateCell.textContent = new Date(review.date).toLocaleDateString('it-IT');
                        row.appendChild(dateCell);
                        
                        const articlesCountCell = document.createElement('td');
                        articlesCountCell.textContent = review.articles ? review.articles.length : 0;
                        row.appendChild(articlesCountCell);
                        
                        const actionsCell = document.createElement('td');
                        actionsCell.className = 'action-cell';
                        
                        // Pulsante Visualizza
                        const viewBtn = document.createElement('button');
                        viewBtn.textContent = 'Visualizza';
                        viewBtn.style.backgroundColor = '#2196F3';
                        viewBtn.addEventListener('click', () => viewReview(review.id));
                        actionsCell.appendChild(viewBtn);
                        
                        // Pulsante Elimina
                        const deleteBtn = document.createElement('button');
                        deleteBtn.textContent = 'Elimina';
                        deleteBtn.style.backgroundColor = '#f44336';
                        deleteBtn.addEventListener('click', () => deleteReview(review.id));
                        actionsCell.appendChild(deleteBtn);
                        
                        row.appendChild(actionsCell);
                        
                        savedReviewsBody.appendChild(row);
                    });
                } else {
                    savedReviewsContainer.style.display = 'none';
                }
            }
            
            // Funzione per visualizzare una rassegna salvata
            function viewReview(reviewId) {
                const review = savedPressReviews.find(r => r.id === reviewId);
                if (!review) return;
                
                // Imposta il contenuto nel modal
                viewReviewContent.innerHTML = review.htmlContent;
                viewReviewContent.dataset.reviewId = reviewId;
                
                // Mostra il modal
                viewReviewModal.style.display = 'block';
            }
            
            // Funzione per eliminare una rassegna
            function deleteReview(reviewId) {
                if (confirm('Sei sicuro di voler eliminare questa rassegna stampa?')) {
                    // Rimuovi la rassegna dall'array
                    savedPressReviews = savedPressReviews.filter(r => r.id !== reviewId);
                    
                    // Aggiorna il localStorage
                    saveReviewsToLocalStorage();
                    
                    // Aggiorna la tabella
                    updateSavedReviewsList();
                    
                    showStatus('success', 'Rassegna stampa eliminata con successo.');
                }
            }
            
            // Inizializza la pagina
            updateSavedArticlesTable();
            updateSavedReviewsList();
        });
    </script>
</body>
</html>
